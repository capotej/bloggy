<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Mongrel::DirHandler</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Mongrel::DirHandler</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/mongrel/handlers_rb.html">
                lib/mongrel/handlers.rb
                </a>
        <br />
                <a href="../../files/lib/mongrel/handlers_rb.html">
                lib/mongrel/handlers.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="HttpHandler.html">
                HttpHandler
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Serves the contents of a directory. You give it the path to the root where
the files are located, and it tries to find the files based on the
PATH_INFO inside the directory. If the requested path is a directory then
it returns a simple directory listing.
</p>
<p>
It does a simple protection against going outside it&#8216;s root path by
converting all paths to an absolute expanded path, and then making sure
that the final expanded path includes the root path. If it doesn&#8216;t
than it simply gives a 404.
</p>
<p>
If you pass nil as the root path, it will not check any locations or expand
any paths. This lets you serve files from multiple drives on win32. It
should probably not be used in a public-facing way without additional
checks.
</p>
<p>
The default content type is &quot;text/plain; charset=ISO-8859-1&quot; but
you can change it anything you want using the
DirHandler.default_content_type attribute.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000208">add_mime_type</a>&nbsp;&nbsp;
      <a href="#M000214">add_mime_type</a>&nbsp;&nbsp;
      <a href="#M000204">can_serve</a>&nbsp;&nbsp;
      <a href="#M000210">can_serve</a>&nbsp;&nbsp;
      <a href="#M000203">new</a>&nbsp;&nbsp;
      <a href="#M000209">new</a>&nbsp;&nbsp;
      <a href="#M000207">process</a>&nbsp;&nbsp;
      <a href="#M000213">process</a>&nbsp;&nbsp;
      <a href="#M000205">send_dir_listing</a>&nbsp;&nbsp;
      <a href="#M000211">send_dir_listing</a>&nbsp;&nbsp;
      <a href="#M000206">send_file</a>&nbsp;&nbsp;
      <a href="#M000212">send_file</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">MIME_TYPES_FILE</td>
          <td>=</td>
          <td class="context-item-value">&quot;mime_types.yml&quot;</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">MIME_TYPES</td>
          <td>=</td>
          <td class="context-item-value">YAML.load_file(File.join(File.dirname(__FILE__), MIME_TYPES_FILE))</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">ONLY_HEAD_GET</td>
          <td>=</td>
          <td class="context-item-value">&quot;Only HEAD and GET allowed.&quot;.freeze</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">MIME_TYPES_FILE</td>
          <td>=</td>
          <td class="context-item-value">&quot;mime_types.yml&quot;</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">MIME_TYPES</td>
          <td>=</td>
          <td class="context-item-value">YAML.load_file(File.join(File.dirname(__FILE__), MIME_TYPES_FILE))</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">ONLY_HEAD_GET</td>
          <td>=</td>
          <td class="context-item-value">&quot;Only HEAD and GET allowed.&quot;.freeze</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">default_content_type</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">default_content_type</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">path</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">path</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000208" class="method-detail">
        <a name="M000208"></a>

        <div class="method-heading">
          <a href="#M000208" class="method-signature">
          <span class="method-name">add_mime_type</span><span class="method-args">(extension, type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
There is a small number of default mime types for extensions, but this lets
you add any others you&#8216;ll need when serving content.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000208-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000208-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 276</span>
276:     <span class="ruby-keyword kw">def</span> <span class="ruby-constant">DirHandler</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_mime_type</span>(<span class="ruby-identifier">extension</span>, <span class="ruby-identifier">type</span>)
277:       <span class="ruby-constant">MIME_TYPES</span>[<span class="ruby-identifier">extension</span>] = <span class="ruby-identifier">type</span>
278:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000214" class="method-detail">
        <a name="M000214"></a>

        <div class="method-heading">
          <a href="#M000214" class="method-signature">
          <span class="method-name">add_mime_type</span><span class="method-args">(extension, type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
There is a small number of default mime types for extensions, but this lets
you add any others you&#8216;ll need when serving content.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000214-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000214-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 276</span>
276:     <span class="ruby-keyword kw">def</span> <span class="ruby-constant">DirHandler</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_mime_type</span>(<span class="ruby-identifier">extension</span>, <span class="ruby-identifier">type</span>)
277:       <span class="ruby-constant">MIME_TYPES</span>[<span class="ruby-identifier">extension</span>] = <span class="ruby-identifier">type</span>
278:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000203" class="method-detail">
        <a name="M000203"></a>

        <div class="method-heading">
          <a href="#M000203" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(path, listing_allowed=true, index_html=&quot;index.html&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
You give it the path to the directory root and and optional listing_allowed
and index_html
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000203-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000203-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 121</span>
121:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">listing_allowed</span>=<span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">index_html</span>=<span class="ruby-value str">&quot;index.html&quot;</span>)
122:       <span class="ruby-ivar">@path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">path</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">path</span>
123:       <span class="ruby-ivar">@listing_allowed</span> = <span class="ruby-identifier">listing_allowed</span>
124:       <span class="ruby-ivar">@index_html</span> = <span class="ruby-identifier">index_html</span>
125:       <span class="ruby-ivar">@default_content_type</span> = <span class="ruby-value str">&quot;application/octet-stream&quot;</span>.<span class="ruby-identifier">freeze</span>
126:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000209" class="method-detail">
        <a name="M000209"></a>

        <div class="method-heading">
          <a href="#M000209" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(path, listing_allowed=true, index_html=&quot;index.html&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
You give it the path to the directory root and and optional listing_allowed
and index_html
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000209-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000209-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 121</span>
121:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">listing_allowed</span>=<span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">index_html</span>=<span class="ruby-value str">&quot;index.html&quot;</span>)
122:       <span class="ruby-ivar">@path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">path</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">path</span>
123:       <span class="ruby-ivar">@listing_allowed</span> = <span class="ruby-identifier">listing_allowed</span>
124:       <span class="ruby-ivar">@index_html</span> = <span class="ruby-identifier">index_html</span>
125:       <span class="ruby-ivar">@default_content_type</span> = <span class="ruby-value str">&quot;application/octet-stream&quot;</span>.<span class="ruby-identifier">freeze</span>
126:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000204" class="method-detail">
        <a name="M000204"></a>

        <div class="method-heading">
          <a href="#M000204" class="method-signature">
          <span class="method-name">can_serve</span><span class="method-args">(path_info)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks if the given path can be served and returns the full path (or nil if
not).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000204-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000204-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 129</span>
129:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">can_serve</span>(<span class="ruby-identifier">path_info</span>)
130: 
131:       <span class="ruby-identifier">req_path</span> = <span class="ruby-constant">HttpRequest</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">path_info</span>)
132:       <span class="ruby-comment cmt"># Add the drive letter or root path</span>
133:       <span class="ruby-identifier">req_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@path</span>, <span class="ruby-identifier">req_path</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@path</span>
134:       <span class="ruby-identifier">req_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span> <span class="ruby-identifier">req_path</span>
135:       
136:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">req_path</span> <span class="ruby-keyword kw">and</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@path</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">req_path</span>.<span class="ruby-identifier">index</span>(<span class="ruby-ivar">@path</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
137:         <span class="ruby-comment cmt"># It exists and it's in the right location</span>
138:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span> <span class="ruby-identifier">req_path</span>
139:           <span class="ruby-comment cmt"># The request is for a directory</span>
140:           <span class="ruby-identifier">index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-ivar">@index_html</span>)
141:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">index</span>
142:             <span class="ruby-comment cmt"># Serve the index</span>
143:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">index</span>
144:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@listing_allowed</span>
145:             <span class="ruby-comment cmt"># Serve the directory</span>
146:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">req_path</span>
147:           <span class="ruby-keyword kw">else</span>
148:             <span class="ruby-comment cmt"># Do not serve anything</span>
149:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
150:           <span class="ruby-keyword kw">end</span>
151:         <span class="ruby-keyword kw">else</span>
152:           <span class="ruby-comment cmt"># It's a file and it's there</span>
153:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">req_path</span>
154:         <span class="ruby-keyword kw">end</span>
155:       <span class="ruby-keyword kw">else</span>
156:         <span class="ruby-comment cmt"># does not exist or isn't in the right spot</span>
157:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
158:       <span class="ruby-keyword kw">end</span>
159:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000210" class="method-detail">
        <a name="M000210"></a>

        <div class="method-heading">
          <a href="#M000210" class="method-signature">
          <span class="method-name">can_serve</span><span class="method-args">(path_info)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks if the given path can be served and returns the full path (or nil if
not).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000210-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000210-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 129</span>
129:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">can_serve</span>(<span class="ruby-identifier">path_info</span>)
130: 
131:       <span class="ruby-identifier">req_path</span> = <span class="ruby-constant">HttpRequest</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">path_info</span>)
132:       <span class="ruby-comment cmt"># Add the drive letter or root path</span>
133:       <span class="ruby-identifier">req_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@path</span>, <span class="ruby-identifier">req_path</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@path</span>
134:       <span class="ruby-identifier">req_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span> <span class="ruby-identifier">req_path</span>
135:       
136:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">req_path</span> <span class="ruby-keyword kw">and</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@path</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">req_path</span>.<span class="ruby-identifier">index</span>(<span class="ruby-ivar">@path</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>)
137:         <span class="ruby-comment cmt"># It exists and it's in the right location</span>
138:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span> <span class="ruby-identifier">req_path</span>
139:           <span class="ruby-comment cmt"># The request is for a directory</span>
140:           <span class="ruby-identifier">index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-ivar">@index_html</span>)
141:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">index</span>
142:             <span class="ruby-comment cmt"># Serve the index</span>
143:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">index</span>
144:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@listing_allowed</span>
145:             <span class="ruby-comment cmt"># Serve the directory</span>
146:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">req_path</span>
147:           <span class="ruby-keyword kw">else</span>
148:             <span class="ruby-comment cmt"># Do not serve anything</span>
149:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
150:           <span class="ruby-keyword kw">end</span>
151:         <span class="ruby-keyword kw">else</span>
152:           <span class="ruby-comment cmt"># It's a file and it's there</span>
153:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">req_path</span>
154:         <span class="ruby-keyword kw">end</span>
155:       <span class="ruby-keyword kw">else</span>
156:         <span class="ruby-comment cmt"># does not exist or isn't in the right spot</span>
157:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
158:       <span class="ruby-keyword kw">end</span>
159:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000207" class="method-detail">
        <a name="M000207"></a>

        <div class="method-heading">
          <a href="#M000207" class="method-signature">
          <span class="method-name">process</span><span class="method-args">(request, response)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Process the request to either serve a file or a directory listing if
allowed (based on the listing_allowed parameter to the constructor).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000207-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000207-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 249</span>
249:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
250:       <span class="ruby-identifier">req_method</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUEST_METHOD</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">GET</span>
251:       <span class="ruby-identifier">req_path</span> = <span class="ruby-identifier">can_serve</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">PATH_INFO</span>]
252:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">req_path</span>
253:         <span class="ruby-comment cmt"># not found, return a 404</span>
254:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">404</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
255:           <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;File not found&quot;</span>
256:         <span class="ruby-keyword kw">end</span>
257:       <span class="ruby-keyword kw">else</span>
258:         <span class="ruby-keyword kw">begin</span>
259:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span> <span class="ruby-identifier">req_path</span>
260:             <span class="ruby-identifier">send_dir_listing</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUEST_URI</span>], <span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">response</span>)
261:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">req_method</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">HEAD</span>
262:             <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-keyword kw">true</span>)
263:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">req_method</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">GET</span>
264:             <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-keyword kw">false</span>)
265:           <span class="ruby-keyword kw">else</span>
266:             <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">403</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span> <span class="ruby-identifier">out</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">ONLY_HEAD_GET</span>) }
267:           <span class="ruby-keyword kw">end</span>
268:         <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">details</span>
269:           <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Error sending file #{req_path}: #{details}&quot;</span>
270:         <span class="ruby-keyword kw">end</span>
271:       <span class="ruby-keyword kw">end</span>
272:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000213" class="method-detail">
        <a name="M000213"></a>

        <div class="method-heading">
          <a href="#M000213" class="method-signature">
          <span class="method-name">process</span><span class="method-args">(request, response)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Process the request to either serve a file or a directory listing if
allowed (based on the listing_allowed parameter to the constructor).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000213-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000213-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 249</span>
249:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
250:       <span class="ruby-identifier">req_method</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUEST_METHOD</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">GET</span>
251:       <span class="ruby-identifier">req_path</span> = <span class="ruby-identifier">can_serve</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">PATH_INFO</span>]
252:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">req_path</span>
253:         <span class="ruby-comment cmt"># not found, return a 404</span>
254:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">404</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
255:           <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;File not found&quot;</span>
256:         <span class="ruby-keyword kw">end</span>
257:       <span class="ruby-keyword kw">else</span>
258:         <span class="ruby-keyword kw">begin</span>
259:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span> <span class="ruby-identifier">req_path</span>
260:             <span class="ruby-identifier">send_dir_listing</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUEST_URI</span>], <span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">response</span>)
261:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">req_method</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">HEAD</span>
262:             <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-keyword kw">true</span>)
263:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">req_method</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">GET</span>
264:             <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-keyword kw">false</span>)
265:           <span class="ruby-keyword kw">else</span>
266:             <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">403</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span> <span class="ruby-identifier">out</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">ONLY_HEAD_GET</span>) }
267:           <span class="ruby-keyword kw">end</span>
268:         <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">details</span>
269:           <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Error sending file #{req_path}: #{details}&quot;</span>
270:         <span class="ruby-keyword kw">end</span>
271:       <span class="ruby-keyword kw">end</span>
272:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000205" class="method-detail">
        <a name="M000205"></a>

        <div class="method-heading">
          <a href="#M000205" class="method-signature">
          <span class="method-name">send_dir_listing</span><span class="method-args">(base, dir, response)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns a simplistic directory listing if they&#8216;re enabled, otherwise
a 403. Base is the base URI from the REQUEST_URI, dir is the directory to
serve on the file system (comes from <a
href="DirHandler.html#M000204">can_serve</a>()), and response is the <a
href="HttpResponse.html">HttpResponse</a> object to send the results on.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000205-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000205-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 166</span>
166:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_dir_listing</span>(<span class="ruby-identifier">base</span>, <span class="ruby-identifier">dir</span>, <span class="ruby-identifier">response</span>)
167:       <span class="ruby-comment cmt"># take off any trailing / so the links come out right</span>
168:       <span class="ruby-identifier">base</span> = <span class="ruby-constant">HttpRequest</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">base</span>)
169:       <span class="ruby-identifier">base</span>.<span class="ruby-identifier">chop!</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">base</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;/&quot;</span>[<span class="ruby-value">-1</span>]
170: 
171:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@listing_allowed</span>
172:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">200</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
173:           <span class="ruby-identifier">head</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-value str">&quot;text/html&quot;</span>
174:           <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Directory Listing&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>
175:           <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">entries</span>(<span class="ruby-identifier">dir</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
176:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">child</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;.&quot;</span>
177:             <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&lt;a href=\&quot;#{base}/#{ HttpRequest.escape(child)}\&quot;&gt;&quot;</span>
178:             <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">child</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;..&quot;</span> <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;Up to parent..&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">child</span>)
179:             <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/a&gt;&lt;br/&gt;&quot;</span>
180:           <span class="ruby-keyword kw">end</span>
181:           <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>
182:         <span class="ruby-keyword kw">end</span>
183:       <span class="ruby-keyword kw">else</span>
184:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">403</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
185:           <span class="ruby-identifier">out</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;Directory listings not allowed&quot;</span>)
186:         <span class="ruby-keyword kw">end</span>
187:       <span class="ruby-keyword kw">end</span>
188:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000211" class="method-detail">
        <a name="M000211"></a>

        <div class="method-heading">
          <a href="#M000211" class="method-signature">
          <span class="method-name">send_dir_listing</span><span class="method-args">(base, dir, response)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns a simplistic directory listing if they&#8216;re enabled, otherwise
a 403. Base is the base URI from the REQUEST_URI, dir is the directory to
serve on the file system (comes from <a
href="DirHandler.html#M000204">can_serve</a>()), and response is the <a
href="HttpResponse.html">HttpResponse</a> object to send the results on.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000211-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000211-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 166</span>
166:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_dir_listing</span>(<span class="ruby-identifier">base</span>, <span class="ruby-identifier">dir</span>, <span class="ruby-identifier">response</span>)
167:       <span class="ruby-comment cmt"># take off any trailing / so the links come out right</span>
168:       <span class="ruby-identifier">base</span> = <span class="ruby-constant">HttpRequest</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">base</span>)
169:       <span class="ruby-identifier">base</span>.<span class="ruby-identifier">chop!</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">base</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;/&quot;</span>[<span class="ruby-value">-1</span>]
170: 
171:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@listing_allowed</span>
172:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">200</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
173:           <span class="ruby-identifier">head</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-value str">&quot;text/html&quot;</span>
174:           <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Directory Listing&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>
175:           <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">entries</span>(<span class="ruby-identifier">dir</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
176:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">child</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;.&quot;</span>
177:             <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&lt;a href=\&quot;#{base}/#{ HttpRequest.escape(child)}\&quot;&gt;&quot;</span>
178:             <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">child</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;..&quot;</span> <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;Up to parent..&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">child</span>)
179:             <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/a&gt;&lt;br/&gt;&quot;</span>
180:           <span class="ruby-keyword kw">end</span>
181:           <span class="ruby-identifier">out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>
182:         <span class="ruby-keyword kw">end</span>
183:       <span class="ruby-keyword kw">else</span>
184:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">403</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">head</span>,<span class="ruby-identifier">out</span><span class="ruby-operator">|</span>
185:           <span class="ruby-identifier">out</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;Directory listings not allowed&quot;</span>)
186:         <span class="ruby-keyword kw">end</span>
187:       <span class="ruby-keyword kw">end</span>
188:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000206" class="method-detail">
        <a name="M000206"></a>

        <div class="method-heading">
          <a href="#M000206" class="method-signature">
          <span class="method-name">send_file</span><span class="method-args">(req_path, request, response, header_only=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sends the contents of a file back to the user. Not terribly efficient since
it&#8216;s opening and closing the file for each read.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000206-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000206-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 193</span>
193:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-identifier">header_only</span>=<span class="ruby-keyword kw">false</span>)
194: 
195:       <span class="ruby-identifier">stat</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">req_path</span>)
196: 
197:       <span class="ruby-comment cmt"># Set the last modified times as well and etag for all files</span>
198:       <span class="ruby-identifier">mtime</span> = <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">mtime</span>
199:       <span class="ruby-comment cmt"># Calculated the same as apache, not sure how well the works on win32</span>
200:       <span class="ruby-identifier">etag</span> = <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">ETAG_FORMAT</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">mtime</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">ino</span>]
201: 
202:       <span class="ruby-identifier">modified_since</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP_IF_MODIFIED_SINCE</span>]
203:       <span class="ruby-identifier">none_match</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP_IF_NONE_MATCH</span>]
204: 
205:       <span class="ruby-comment cmt"># test to see if this is a conditional request, and test if</span>
206:       <span class="ruby-comment cmt"># the response would be identical to the last response</span>
207:       <span class="ruby-identifier">same_response</span> = <span class="ruby-keyword kw">case</span>
208:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_response_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">httpdate</span>(<span class="ruby-identifier">modified_since</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
209:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">last_response_time</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>                                  <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
210:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">mtime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">last_response_time</span>                                     <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
211:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">none_match</span>     <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">none_match</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'*'</span>                                              <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
212:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">none_match</span>     <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">none_match</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\s*,\s*/</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">etag</span>)              <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
213:                       <span class="ruby-keyword kw">else</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">none_match</span>  <span class="ruby-comment cmt"># validation successful if we get this far and at least one of the header exists</span>
214:                       <span class="ruby-keyword kw">end</span>
215: 
216:       <span class="ruby-identifier">header</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">header</span>
217:       <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">ETAG</span>] = <span class="ruby-identifier">etag</span>
218: 
219:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">same_response</span>
220:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">304</span>) {}
221:       <span class="ruby-keyword kw">else</span>
222:         
223:         <span class="ruby-comment cmt"># First we setup the headers and status then we do a very fast send on the socket directly</span>
224:         
225:         <span class="ruby-comment cmt"># Support custom responses except 404, which is the default. A little awkward. </span>
226:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">200</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">404</span>        
227:         <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">LAST_MODIFIED</span>] = <span class="ruby-identifier">mtime</span>.<span class="ruby-identifier">httpdate</span>
228: 
229:         <span class="ruby-comment cmt"># Set the mime type from our map based on the ending</span>
230:         <span class="ruby-identifier">dot_at</span> = <span class="ruby-identifier">req_path</span>.<span class="ruby-identifier">rindex</span>(<span class="ruby-value str">'.'</span>)
231:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dot_at</span>
232:           <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-constant">MIME_TYPES</span>[<span class="ruby-identifier">req_path</span>[<span class="ruby-identifier">dot_at</span> <span class="ruby-operator">..</span> <span class="ruby-value">-1</span>]] <span class="ruby-operator">||</span> <span class="ruby-ivar">@default_content_type</span>
233:         <span class="ruby-keyword kw">else</span>
234:           <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-ivar">@default_content_type</span>
235:         <span class="ruby-keyword kw">end</span>
236: 
237:         <span class="ruby-comment cmt"># send a status with out content length</span>
238:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">send_status</span>(<span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span>)
239:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">send_header</span>
240: 
241:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">header_only</span>
242:           <span class="ruby-identifier">response</span>.<span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CHUNK_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>)
243:         <span class="ruby-keyword kw">end</span>
244:       <span class="ruby-keyword kw">end</span>
245:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000212" class="method-detail">
        <a name="M000212"></a>

        <div class="method-heading">
          <a href="#M000212" class="method-signature">
          <span class="method-name">send_file</span><span class="method-args">(req_path, request, response, header_only=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sends the contents of a file back to the user. Not terribly efficient since
it&#8216;s opening and closing the file for each read.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000212-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000212-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mongrel/handlers.rb, line 193</span>
193:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-identifier">header_only</span>=<span class="ruby-keyword kw">false</span>)
194: 
195:       <span class="ruby-identifier">stat</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">req_path</span>)
196: 
197:       <span class="ruby-comment cmt"># Set the last modified times as well and etag for all files</span>
198:       <span class="ruby-identifier">mtime</span> = <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">mtime</span>
199:       <span class="ruby-comment cmt"># Calculated the same as apache, not sure how well the works on win32</span>
200:       <span class="ruby-identifier">etag</span> = <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">ETAG_FORMAT</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">mtime</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">ino</span>]
201: 
202:       <span class="ruby-identifier">modified_since</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP_IF_MODIFIED_SINCE</span>]
203:       <span class="ruby-identifier">none_match</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">params</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP_IF_NONE_MATCH</span>]
204: 
205:       <span class="ruby-comment cmt"># test to see if this is a conditional request, and test if</span>
206:       <span class="ruby-comment cmt"># the response would be identical to the last response</span>
207:       <span class="ruby-identifier">same_response</span> = <span class="ruby-keyword kw">case</span>
208:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_response_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">httpdate</span>(<span class="ruby-identifier">modified_since</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
209:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">last_response_time</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>                                  <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
210:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">mtime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">last_response_time</span>                                     <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
211:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">none_match</span>     <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">none_match</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'*'</span>                                              <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
212:                       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">none_match</span>     <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">none_match</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\s*,\s*/</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">etag</span>)              <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>
213:                       <span class="ruby-keyword kw">else</span> <span class="ruby-identifier">modified_since</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">none_match</span>  <span class="ruby-comment cmt"># validation successful if we get this far and at least one of the header exists</span>
214:                       <span class="ruby-keyword kw">end</span>
215: 
216:       <span class="ruby-identifier">header</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">header</span>
217:       <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">ETAG</span>] = <span class="ruby-identifier">etag</span>
218: 
219:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">same_response</span>
220:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">304</span>) {}
221:       <span class="ruby-keyword kw">else</span>
222:         
223:         <span class="ruby-comment cmt"># First we setup the headers and status then we do a very fast send on the socket directly</span>
224:         
225:         <span class="ruby-comment cmt"># Support custom responses except 404, which is the default. A little awkward. </span>
226:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">200</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">404</span>        
227:         <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">LAST_MODIFIED</span>] = <span class="ruby-identifier">mtime</span>.<span class="ruby-identifier">httpdate</span>
228: 
229:         <span class="ruby-comment cmt"># Set the mime type from our map based on the ending</span>
230:         <span class="ruby-identifier">dot_at</span> = <span class="ruby-identifier">req_path</span>.<span class="ruby-identifier">rindex</span>(<span class="ruby-value str">'.'</span>)
231:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dot_at</span>
232:           <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-constant">MIME_TYPES</span>[<span class="ruby-identifier">req_path</span>[<span class="ruby-identifier">dot_at</span> <span class="ruby-operator">..</span> <span class="ruby-value">-1</span>]] <span class="ruby-operator">||</span> <span class="ruby-ivar">@default_content_type</span>
233:         <span class="ruby-keyword kw">else</span>
234:           <span class="ruby-identifier">header</span>[<span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-ivar">@default_content_type</span>
235:         <span class="ruby-keyword kw">end</span>
236: 
237:         <span class="ruby-comment cmt"># send a status with out content length</span>
238:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">send_status</span>(<span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span>)
239:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">send_header</span>
240: 
241:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">header_only</span>
242:           <span class="ruby-identifier">response</span>.<span class="ruby-identifier">send_file</span>(<span class="ruby-identifier">req_path</span>, <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Const</span><span class="ruby-operator">::</span><span class="ruby-constant">CHUNK_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>)
243:         <span class="ruby-keyword kw">end</span>
244:       <span class="ruby-keyword kw">end</span>
245:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>